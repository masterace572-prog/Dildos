name: Telegram Bot Server

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install python-telegram-bot flask requests
        sudo apt-get update
        sudo apt-get install -y gcc wget

    - name: Compile UDP tool
      run: |
        gcc -o udp_flood udp_flood.c -lpthread -D_GNU_SOURCE -O3
        ls -la udp_flood

    - name: Download and setup ngrok
      run: |
        wget -q https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz
        tar -xzf ngrok-v3-stable-linux-amd64.tgz
        chmod +x ngrok

    - name: Start Bot with Ngrok
      env:
        BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
        NGROK_AUTH: ${{ secrets.NGROK_AUTH }}
      run: |
        # Authenticate ngrok
        ./ngrok authtoken $NGROK_AUTH
        
        # Start ngrok tunnel in background
        ./ngrok http 8080 > ngrok.log 2>&1 &
        
        # Wait for ngrok to start
        sleep 5
        
        # Get public URL from ngrok API
        curl -s http://localhost:4040/api/tunnels > tunnels.json
        echo "Ngrok tunnels:"
        cat tunnels.json
        
        # Start the bot server
        python bot_server.py
