name: Telegram Bot Server

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install python-telegram-bot requests pyngrok
        sudo apt-get update
        sudo apt-get install -y gcc

    - name: Compile UDP tool
      run: |
        gcc -o udp_flood udp_flood.c -lpthread -D_GNU_SOURCE -O3
        ls -la udp_flood

    - name: Setup Ngrok
      run: |
        curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
        echo "deb https://ngrok-agent.s3.amazonaws.com buster main" | sudo tee /etc/apt/sources.list.d/ngrok.list
        sudo apt update && sudo apt install ngrok

    - name: Start Bot with Ngrok
      env:
        BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
        NGROK_AUTH: ${{ secrets.NGROK_AUTH }}
      run: |
        # Set up ngrok auth
        ngrok config add-authtoken $NGROK_AUTH
        
        # Start ngrok tunnel in background
        ngrok http 8080 --log=stdout > ngrok.log 2>&1 &
        
        # Wait for ngrok to start
        sleep 10
        
        # Get public URL
        NGROK_URL=$(curl -s http://localhost:4040/api/tunnels | jq -r '.tunnels[0].public_url')
        echo "Public URL: $NGROK_URL"
        
        # Start the bot
        python bot_server.py &
        
        # Keep the workflow running
        sleep 3600
